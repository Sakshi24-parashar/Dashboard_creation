<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sakshi BI Dashboard</title>

<link rel="stylesheet" href="style.css">

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body>

<div class="chat-box" id="dashboard">

<div class="top-controls">
  <input type="file" id="excelInput" accept=".xls,.xlsx,.csv">

  <select id="metricSelect"></select>
  <select id="categoryFilter"></select>

  <input type="date" id="startDate">
  <input type="date" id="endDate">

  <button onclick="switchChart()">Switch Chart</button>
  <button onclick="exportPDF()">Export PDF</button>
  <button onclick="toggleTheme()">ðŸŒ—</button>
</div>

<div class="summary" id="summary"></div>

<div class="kpi-grid" id="kpis"></div>

<div class="grid-2">
  <canvas id="trend"></canvas>
  <canvas id="pie"></canvas>
</div>

<div class="grid-2">
  <canvas id="bar"></canvas>
  <canvas id="metricChart"></canvas>
</div>

</div>

<script>
let rawData=[],dateCol,catCol,numericCols=[];
let chartType="bar";
let charts={};

excelInput.addEventListener("change",e=>{
 const file=e.target.files[0];
 const r=new FileReader();
 r.onload=x=>{
  const wb=XLSX.read(new Uint8Array(x.target.result),{type:"array"});
  const sheet=wb.Sheets[wb.SheetNames[0]];
  rawData=XLSX.utils.sheet_to_json(sheet);
  smartDetect();
 };
 r.readAsArrayBuffer(file);
});

function smartDetect(){
 const cols=Object.keys(rawData[0]);

 dateCol=cols.find(c=>rawData.some(r=>!isNaN(Date.parse(r[c]))));
 catCol=cols.find(c=>typeof rawData[0][c]==="string");
 numericCols=cols.filter(c=>rawData.some(r=>!isNaN(parseFloat(r[c]))));

 buildControls();
 render();
}

function buildControls(){
 metricSelect.innerHTML=numericCols.map(c=>`<option>${c}</option>`).join("");

 const cats=[...new Set(rawData.map(r=>r[catCol]))];
 categoryFilter.innerHTML=`<option value="">All</option>`+
 cats.map(c=>`<option>${c}</option>`).join("");

 metricSelect.onchange=render;
 categoryFilter.onchange=render;
 startDate.onchange=render;
 endDate.onchange=render;
}

function filterData(){
 let d=[...rawData];

 if(categoryFilter.value)
   d=d.filter(r=>r[catCol]==categoryFilter.value);

 if(dateCol){
  if(startDate.value)
    d=d.filter(r=>new Date(r[dateCol])>=new Date(startDate.value));
  if(endDate.value)
    d=d.filter(r=>new Date(r[dateCol])<=new Date(endDate.value));
 }

 return d;
}

function render(){
 const data=filterData();
 if(!data.length) return;

 const metric=metricSelect.value;

 const total=data.reduce((a,b)=>a+(+b[metric]||0),0);
 const avg=(total/data.length).toFixed(1);

 kpis.innerHTML=`
 <div class="kpi">Total<br><b>${total.toFixed(1)}</b></div>
 <div class="kpi">Average<br><b>${avg}</b></div>
 <div class="kpi">Records<br><b>${data.length}</b></div>
 <div class="kpi">Max<br><b>${Math.max(...data.map(r=>+r[metric]||0))}</b></div>
 `;

 const agg={};
 data.forEach(r=>agg[r[catCol]]=(agg[r[catCol]]||0)+(+r[metric]||0));

 /* ===== TOP 10 + OTHERS ===== */
 const sorted = Object.entries(agg).sort((a,b)=>b[1]-a[1]);
 const top10 = sorted.slice(0,10);
 const others = sorted.slice(10);

 let labels = top10.map(x=>x[0]);
 let values = top10.map(x=>x[1]);

 if(others.length){
  const othersSum = others.reduce((a,b)=>a+b[1],0);
  labels.push("Others");
  values.push(othersSum);
 }

 draw("pie","pie",labels,values);
 draw("bar","bar",labels,values);

 draw("metricChart",chartType,
   data.map((_,i)=>i+1),
   data.map(r=>+r[metric]||0)
 );

 if(dateCol){
  const sortedDates=[...data].sort((a,b)=>new Date(a[dateCol])-new Date(b[dateCol]));
  draw("trend","line",
    sortedDates.map(r=>r[dateCol]),
    sortedDates.map(r=>+r[metric]||0)
  );
 }

 generateInsights(labels,values,total);
}

function draw(id,type,labels,data){
 if(charts[id]) charts[id].destroy();

 charts[id]=new Chart(document.getElementById(id),{
  type,
  data:{labels,datasets:[{label:id,data,borderWidth:2}]},
  options:{
   responsive:true,
   maintainAspectRatio:false,
   scales:type==="pie"?{}:{y:{beginAtZero:true}}
  }
 });
}

function switchChart(){
 chartType=chartType==="bar"?"line":"bar";
 render();
}

function generateInsights(labels,values,total){
 if(!labels.length) return;
 const max=Math.max(...values);
 const idx=values.indexOf(max);
 const share=((max/total)*100).toFixed(1);

 summary.innerHTML=`
 ðŸ“ˆ Top category: <b>${labels[idx]}</b><br>
 ðŸ¥‡ Contribution: <b>${share}%</b><br>
 ðŸ“Š Highest value: <b>${max.toFixed(1)}</b>
 `;
}

function toggleTheme(){
 document.body.classList.toggle("light");
}

async function exportPDF(){
 const canvas=await html2canvas(dashboard);
 const img=canvas.toDataURL("image/png");
 const pdf=new jspdf.jsPDF("l","mm","a4");
 pdf.addImage(img,"PNG",10,10,280,190);
 pdf.save("dashboard.pdf");
}
</script>

</body>
</html>

